jQuery(function(e){userData.articleData&&userData.articleData.thumbnail&&(userData.thumbnail=userData.articleData.thumbnail||{});var a=function(a){for(var t=(function(e){var a=e.get(0),t=0;if("selectionStart"in a)t=a.selectionStart;else if("selection"in document){a.focus();var i=document.selection.createRange(),r=document.selection.createRange().text.length;i.moveStart("character",-a.value.length),t=i.text.length-r}return t}),i="",r=0;r<a.length;r++)i+=/^image/.test(a[r].type)?"![]("+a[r].src+")\n":"["+a[r].name+"]("+a[r].src+")\n";var n=t(e(userData.form.content)),u=userData.form.content.value,s=u.substr(0,n)+i+u.substr(n);userData.form.content.value=s},t=function(a){var t=e.ajax({url:userData.root+"/script/run/markdown_preview/",type:"post",data:{title:"...",nest_srl:userData.form.nest_srl.value,content:userData.form.content.value}});t.done(function(e){a(e)})},i=function(){var e=uploader.queue.items.files,a=!1;if(userData.form.article_srl.value&&uploader.queue.$queue.children(".is-thumbnail").length)return!1;for(var t=0;t<e.length;t++)if(/^image/i.test(e[t].type)){a=!0;break}return!(!a||userData.thumbnail_image)&&(alert("not make thumbnail image"),uploader.queue.$queue.find(".btn-make-thumbnail").eq(0).focus(),!0)},r=function(a,t){function i(e,a,t,i,r){var n={};switch(e){case"resize":i<r?(n.width=parseInt(i/r*t),n.height=parseInt(t)):(n.width=parseInt(a),n.height=parseInt(r/i*a));break;case"resizeWidth":n.width=parseInt(a),n.height=parseInt(r/i*a);break;case"resizeHeight":n.width=parseInt(i/r*t),n.height=parseInt(t);break;default:n.width=parseInt(a),n.height=parseInt(t)}return n}var r=e.Deferred(),n=new Image;return n.onload=function(e){var t=i(a.type,a.size.width,a.size.height,n.width,n.height);r.resolve(t)},n.src=userData.root+"/"+t.src,r.promise()};window.uploader=new RGUploader(e("#queuesManager"),{autoUpload:!0,allowFileTypes:["jpeg","png","gif"],limitSize:3e6,limitSizeTotal:1e7,uploadScript:userData.root+"/file/upload/",removeScript:userData.root+"/file/remove/",uploadParams:{table:"file_tmp",upload_loc:userData.originalPath},srcPrefixName:userData.url,queue:{style:"list",height:150,limit:10,datas:userData.pushDatas,buttons:[{name:"open file",iconName:"open_in_new",action:function(e,a){window.open(a.fullSrc)}},{name:"make thumbnail image",iconName:"apps",className:"btn-make-thumbnail",show:function(e){return"image"==e.type.split("/")[0]},action:function(e,a){if(!e.plugin.child.thumbnail)return!1;var t=e.plugin.child.thumbnail,i={};if(a.srl==userData.thumbnail.srl&&(i.points=userData.thumbnail.points,i.zoom=userData.thumbnail.zoom),userData.thumbnail.type&&"crop"==userData.thumbnail.type||!userData.thumbnail.type)t.open(a,i);else{var n=r(userData.thumbnailSet,a);n.done(function(e){t.assignOption({output:{size:{width:e.width,height:e.height}},croppie:{viewport:{width:e.width,height:e.height}}}),t.open(a,i)})}}},{name:"insert editor",iconName:"center_focus_strong",action:function(e,t){a([{src:t.fullSrc,name:t.name,type:t.type}])}},{name:"remove queue",iconName:"close",action:function(e,a){e.queue.removeQueue(a.srl,!1,!0)}}]},plugin:[{name:"preview",obj:new RG_Preview},{name:"sizeinfo",obj:new RG_Sizeinfo},{name:"dnd",obj:new RG_DragAndDrop},{name:"thumbnail",obj:new RG_Thumbnail({width:640,height:480,mobileSize:640,url_croppieCSS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.css",url_croppieJS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.min.js",output:{type:"canvas",quality:.85,format:"jpeg",size:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height}},croppie:{viewport:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height,type:"square"}},doneCallback:function(e,a,t){var i=".btn-make-thumbnail";userData.thumbnail_image=e.src;var r=a.queue.$queue.find(i);r.removeClass("on is-thumbnail"),a.queue.selectQueueElement(t.id).addClass("is-thumbnail").find(i).addClass("on");var n=a.plugin.child.thumbnail.croppie.get(),u=a.plugin.child.thumbnail.options;userData.thumbnail.srl=t.srl,userData.thumbnail.points=n.points,userData.thumbnail.zoom=n.zoom,userData.thumbnail.size=u.output.size}})}],uploadDataFilter:function(e){return{state:e[0].state,response:{src:e[0].loc,srl:e[0].srl,name:e[0].name,table:"file_tmp"}}},removeParamsFilter:function(e){return{data:JSON.stringify([{table:e.table,srl:e.srl}])}},removeDataFilter:function(e){},uploadComplete:function(e){userData.addQueue.push(e.srl)},init:function(e){for(var a=0;a<userData.pushDatas.length;a++)"file_tmp"===userData.pushDatas[a].table&&userData.addQueue.push(userData.pushDatas[a].srl);if(userData.articleData.thumbnail){var t=e.queue.selectQueueElement(userData.articleData.thumbnail.srl);t.addClass("is-thumbnail").find(".btn-make-thumbnail").addClass("on")}}});var n=e("div.mk-editor"),u=n.find("a[data-control]");u.on("click",function(){var a=e(this).attr("data-control"),i=n.find("[data-target="+a+"]");if(!e(this).hasClass("active")&&(u.removeClass("active"),e(this).addClass("active"),n.find("[data-target]").removeClass("show"),i.addClass("show"),"preview"==a&&userData.form.content.value)){t(function(e){i.html(e)})}return!1}),e(userData.form).on("submit",function(){if(i())return!1;var e=userData.articleData;userData.thumbnail_image&&(userData.form.thumbnail_image.value=userData.thumbnail_image),e.thumbnail=userData.thumbnail,userData.form.addQueue.value=userData.addQueue.toString(),e=encodeURIComponent(JSON.stringify(e)),userData.form.json.value=e})});